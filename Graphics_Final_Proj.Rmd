---
title: "Graphics Project"
output:
  html_document:
    df_print: paged
---

```{r,include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message =  FALSE)
library(ggplot2)
library(GGally)
library(dplyr)
library(tidyr)
library(mi)
library(forcats)
require(gdata)
library(tidyverse)
library(rvest)
library(vcd)
```

##I. Introduction

##II. Description of the data source

After considering potential influencing factors of diabetes, we are both responsible for collecting data in terms of different factors. Data are all from the original sources and mostly from "Centers for Disease Control and Prevention" and "Bureau of Economic Analysis" from U.S. Department of Commerce. In the form of getting the data, we either directly downloaded excels (or csv) or scraped data from the web pages. 

Factors causing diabetes are grouped by several categories including physical indicators, age, education, diet habits, alcohol, and per capita GDP. Records are based on 53 states of US. In choosing data types, we do have total number and percentage of each factor (variable) for each state; however, every state has different amount of population, we will consider percentages of the totol number of each factor among total population as our metrice.

For physical indicators, High Cholesterol, Hypertension, Inactivity, Obesity, Poor Health and Smoking are counted. 

Age will be classified in 4 categories which are 18-44, 45-64, 65-74 and 75+. In each classification, we have percentages of diagnosed diabetes of each age range for 53 states. 

Since education will enhance one's self-management ability and enrich scientific knowledges so that we wonder if education levels would be a factor and how much it will be related to diabetes. Education levels are specified by three types including under high school, high school and post high school. Each state will have a percentage of diabete rates corresponding to each education levels.

In order to consider diet habits that affacting diabetes, we took sweet beverage consumption among adults and the number of McDonald's location among states as metrices. Unfortunately, we are only able to obtain data of the first kind (sweet beverage consumption) from 24 states. 

Alcohol is a kind of popular lifestyle in US which let us to think about whether excessive alcohol consumption is one of major factor causing diabetes in the long run. 

Moreover, Per capita GDP is also important indicator for representing economic condition of each state, which might potentially affacts the chance of being diabetes.

####Reference

https://gis.cdc.gov/grasp/diabetes/DiabetesAtlas.html <br>
https://www.statista.com/statistics/631235/number-of-mcdonald-s-us-by-state/ <br>
https://www.cdc.gov/alcohol/data-stats.htm <br> 
https://www.cdc.gov/mmwr/volumes/65/wr/mm6507a1.htm <br>
https://apps.bea.gov/itable/iTable.cfm?ReqID=70&step=1#reqid=70&step=1&isuri=1 <br>


##III. Description of data import / cleaning / transformation

For the parts of data that directly downloading excel or csv from orginial websites, we used read.csv() to import into R for further data processing. Those data are including High Cholesterol, Hypertension, Inactivity, Obesity, Poor Health, Smoking, age, education, per capita GDP and number of McDonald's location.

On the other part of data that does not have nice downloadable excel or csv, we used packages tidyverse and rvest to scrap tables from webpages and saved those tables into our .data/raw in .csv format. Those data include alcohol and sweet beverage consumption. In alcohol data frame, we renamed each column as Location, Total Cost, Cost Per Drink, Cost Per Capital respectively. In sweet beverage consumption data frame, we scraped two tables from one web page. After we checked each list item, it turns out that the tables we want are the second and third list elements: one is sweetened beverage consumption that are further specified by different ages, genders, races; the other is sweetened beverage consumption that are further specified by different employment status and education levels. Column names are taken into consideration to define each variable, and we removed the rows we don’t need. All numeric related data are cleaned from character form to numeric or integer form for being ready to later analysis.


####Scraping data from webpages
```{r}
alcohol <- read_html("https://www.cdc.gov/alcohol/data-stats.htm") %>%
  html_nodes("table") %>%
  html_table(fill = TRUE) %>%
  data.frame()
colnames(alcohol) <- c("Location", "Total Cost($)","Cost Per Drink($)","Cost Per Capital($)")
alcohol$`Total Cost($)` <- as.numeric(gsub(",","",alcohol$`Total Cost($)`))
alcohol$`Cost Per Capital($)` <- as.numeric(gsub(",","",alcohol$`Cost Per Capital($)`))
# alcohol
# write.csv(alcohol, file = "alcohol.csv")
```

```{r}
sugar2 <- read_html("https://www.cdc.gov/mmwr/volumes/65/wr/mm6507a1.htm#T2_down") %>%
  html_nodes("table") %>%
  html_table(fill=TRUE) %>%
  .[2] %>%
  data.frame()

colnames(sugar2) <- sugar2[2,]
sugar2 <- sugar2[c(-1,-2,-3),]
sugar2$`18–24` <- as.numeric(sapply(unlist(sugar2$`18–24`),substr,1,4))
sugar2$`25–34` <- as.numeric(sapply(unlist(sugar2$`25–34`),substr,1,4))
sugar2$`35–54` <- as.numeric(sapply(unlist(sugar2$`35–54`),substr,1,4))
sugar2$`≥55` <- as.numeric(sapply(unlist(sugar2$`≥55`),substr,1,4))
sugar2$Male <- as.numeric(sapply(unlist(sugar2$Male),substr,1,4))
sugar2$Female <- as.numeric(sapply(unlist(sugar2$Female),substr,1,4))
sugar2$`White, Non-Hispanic` <- as.numeric(sapply(unlist(sugar2$`White, Non-Hispanic`),substr,1,4))
sugar2$`Black, Non-Hispanic` <- as.numeric(sapply(unlist(sugar2$`Black, Non-Hispanic`),substr,1,4))
sugar2$Hispanic <- as.numeric(sapply(unlist(sugar2$Hispanic),substr,1,4))
sugar2$`Other, Non-Hispanic` <- as.numeric(sapply(unlist(sugar2$`Other, Non-Hispanic`),substr,1,4))
sugar2$`No. respondents` <- as.numeric(gsub(",","",sugar2$`No. respondents`))
# sugar2
# write.csv(sugar2, file = "sugar2.csv")
```

```{r}
sugar3 <- read_html("https://www.cdc.gov/mmwr/volumes/65/wr/mm6507a1.htm#T3_down") %>%
  html_nodes("table") %>%
  html_table(fill=TRUE) %>%
  .[3] %>%
  data.frame()

colnames(sugar3) <- sugar3[2,]
sugar3 <- sugar3[c(-1,-2,-3),]
sugar3$Employed <- as.numeric(sapply(unlist(sugar3$Employed),substr,1,4))
sugar3$`Not employed` <- as.numeric(sapply(unlist(sugar3$`Not employed`),substr,1,4))
sugar3$Retired <- as.numeric(sapply(unlist(sugar3$`Not employed`),substr,1,4))
sugar3$`<High school` <- as.numeric(sapply(unlist(sugar3$`<High school`),substr,1,4))
sugar3$`High school` <- as.numeric(sapply(unlist(sugar3$`High school`),substr,1,4))
sugar3$`Some college` <- as.numeric(sapply(unlist(sugar3$`Some college`),substr,1,4))
sugar3$`College graduate` <- as.numeric(sapply(unlist(sugar3$`College graduate`),substr,1,4))
sugar3$`No. respondents` <- as.numeric(gsub(",","",sugar3$`No. respondents`))
# sugar3
# write.csv(sugar3, file = "sugar3.csv")
```


####Read in Raw Data
```{r}
Sn <- read.csv("data(raw)/Sn.csv",skip = 2, na.strings = "No Data")
Sp <- read.csv("data(raw)/Sp.csv",skip = 2, na.strings = "No Data")
On <- read.csv("data(raw)/On.csv",skip = 2, na.strings = "No Data")
Op <- read.csv("data(raw)/Op.csv",skip = 2, na.strings = "No Data")
PGn <- read.csv("data(raw)/PGn.csv",skip = 2, na.strings = "No Data")
PGp <- read.csv("data(raw)/PGp.csv",skip = 2, na.strings = "No Data")
Dn <- read.csv("data(raw)/Dn.csv",skip = 2, na.strings = "No Data")
Dp <- read.csv("data(raw)/Dp.csv",skip = 2, na.strings = "No Data")
Phn <- read.csv("data(raw)/Phn.csv",skip = 2, na.strings = "No Data")
Php <- read.csv("data(raw)/Php.csv",skip = 2, na.strings = "No Data")
Hypern <- read.csv("data(raw)/Hypern.csv",skip = 2, na.strings = "No Data")
Hyperp <- read.csv("data(raw)/Hyperp.csv",skip = 2, na.strings = "No Data")
HCn <- read.csv("data(raw)/HCn.csv",skip = 2, na.strings = "No Data")
HCp <- read.csv("data(raw)/HCp.csv",skip = 2, na.strings = "No Data")
alcohol <- read.csv("data(raw)/alcohol.csv")
sugar1 <- read.csv("data(raw)/sugar2.csv")
sugar2 <- read.csv("data(raw)/sugar3.csv")
sugar3 <- read.csv("data(raw)/sugar1.csv")
underH <- read.csv("data(raw)/<H.csv",skip = 2, na.strings = "No Data")
H <- read.csv("data(raw)/H.csv",skip = 2, na.strings = "No Data")
postH <- read.csv("data(raw)/>H.csv",skip = 2, na.strings = "No Data")
age1 <- read.csv("data(raw)/18-44.csv",skip = 2, na.strings = "No Data")
age2 <- read.csv("data(raw)/45-64.csv",skip = 2, na.strings = "No Data")
age3 <- read.csv("data(raw)/65-74.csv",skip = 2, na.strings = "No Data")
age4 <- read.csv("data(raw)/75+.csv",skip = 2, na.strings = "No Data")
GDP2015 <- read.csv("data(raw)/2015.csv",skip = 4)
GDP2016 <- read.csv("data(raw)/2016.csv", skip = 4)
mcdonald <- read.xls("data(raw)/mcdonald.xlsx")
```


####Basic Data Cleaning

```{r}
clean <- function(df1,df2){
  df1 <- df1[-nrow(df1),]
  df2 <- df2[-nrow(df2),]
  overall <- full_join(df1,df2, by="State")
  return(overall)
}
clean2 <- function(df1){
  df1 <- df1[-nrow(df1),] %>% select(1:2)
  return(df1)
}
```

```{r}
Smoking <- clean(Sn,Sp)
Smoking$Type <- rep("Smoking",nrow(Smoking))
#Smoking

Obesity <- clean(Op, On)
Obesity$Type <- rep("Obesity",nrow(Obesity))

Poor_Health <- clean(PGn, PGp)
Poor_Health$Type <- rep("Poor_Health",nrow(Poor_Health))

Num <- clean(Dn,Dp)
Num$Type <- rep("Num",nrow(Num))

Inactivity <- clean(Phn,Php)
Inactivity$Type <- rep("Inactivity",nrow(Inactivity))

Hypertension <- clean(Hyperp,Hypern)
Hypertension$Type <- rep("Hypertension",nrow(Hypertension))

Cholesterol <- clean(HCn, HCp)
Cholesterol$Type <- rep("HighCholesterol",nrow(Cholesterol))

alcohol <- alcohol %>% 
  select(2:5) %>% 
  mutate(Num.Drink = Total.Cost.../Cost.Per.Drink...)
names(alcohol)[1] <- "State"

names(sugar1) <- c("State","No.","18-24","25-34","35-54","55+","Male","Female","White","Black","Hispanic","Other")
names(sugar2) <- c("State","No.","Employed","Unemployed","Retired","underHighSchool","HighSchool","College","College.Grad")
names(sugar3) <- c("State","ResponseNum","NoSweetBev","less1perDay","more1perDay")
#sugar3

SweetBev <- full_join(sugar1,sugar2,by="State")
SweetBev <- SweetBev[!duplicated(as.list(SweetBev))]
names(SweetBev)[2] <- "ResNumber"

underH <- clean2(underH)
names(underH) <- c("State","UnderHighSchool")
H <- clean2(H)
names(H) <- c("State","HighSchool")
postH <- clean2(postH)
names(postH) <- c("State","HighSchool+")
education <- full_join(full_join(underH,H,by="State"),postH,by="State")


age1 <- clean2(age1)
age2 <- clean2(age2)
age3 <- clean2(age3)
age4 <- clean2(age4)
names(age1) <- c("State","18-44")
names(age2) <- c("State","45-64")
names(age3) <- c("State","65-74")
names(age4) <- c("State","75+")
Age <- full_join(full_join(full_join(age1,age2,by="State"),age3, by="State"),age4,by="State")

GDP2015 <- GDP2015[1:(nrow(GDP2015)-3),]
GDP2016 <- GDP2016[1:(nrow(GDP2016)-3),]

Indicators <- rbind(Smoking,Obesity,Poor_Health,Num, Inactivity,Hypertension, Cholesterol)
Indicators$Type <- as.factor(Indicators$Type)
mcdonald <- mcdonald %>% select(State, Rank, No..of.Mcdonald.s.locations)
names(mcdonald) <- c("State","Rank","McNumber")
#mcdonald
```


```{r}
ms <- Indicators %>% select(1,3,6) %>% spread(Type, Percentage)
ms1 <- full_join(full_join(full_join(full_join(ms,Age,by="State"),education,by="State"),sugar3%>%select(1,3,4,5),by="State"), mcdonald, by="State")
# ms1 #dataframe of all indicators with percentage values
# 
# Indicators
# 
# Age
# 
# education
# 
# sugar3

# ms2 <- full_join(mcdonald,alcohol%>%select(1,5),by="State")
# ms2 #dataframe of indicators with exact number (mc+alcohol)
# 
# mcdonald
# 
# alcohol
# 
# GDP2015
# 
# GDP2016
```


##IV. Analysis of missing values

Do we have missing values for datasets that involving all the variables?

```{r}
colSums(is.na(ms1))
```

```{r}
extracat::visna(ms1, sort="b")
```

Yes, we do. Here, we visualized missing patterns using the visna function in the extracat package. From above plot, we realized that there are 5 missing patterns by each row, and most columns have some kinds of missing values. By sorting both rows and columns, sweet beverage consumption related variables (NoSweetBev, less1perDay, more1perDay) have the most missing values, and we observed the top two most common missing patterns.


```{r}
#heatmap(1 * is.na(ms1), Rowv = NA, Colv = NA)
#ms1
image(missing_data.frame(ms1))
#extracat::visna(ms1)
```

**Dealing with missing values**

###Minor Risk Factors

**Dot Plots(Facet-wrap)**
```{r}
df_percent <- na.omit(ms1[,1:8][order(ms1$Num,decreasing = T),])
df_percent <- df_percent %>% 
  filter(State != "Median of States") %>% 
  mutate(Rank = c(1:51))
#df_percent
```

```{r}
df_num <- gather(df_percent,key = "Type", value = "Percent", colnames(df_percent%>%select(2:4,6:8)))
#df_num
```


```{r}
ggplot(df_num%>%filter(State != "Puerto Rico"),aes(x=Num, y=Percent))+geom_point() + facet_wrap(~ Type)+ggtitle("Diagnosed Diabetes vs. Potential Risk Factors") + xlab("Diagnosed Diabetes")
```

**Parallel Coordinates Plot**

```{r}
df_all <- gather(df_percent,key = "RiskFactor", value = "Percent", colnames(df_percent%>%select(2:8)))
#df_all
temp <- df_all %>% group_by(RiskFactor) %>%
  mutate(Percent = scales::rescale(Percent)) %>% ungroup()
g1 <- ggplot(temp%>%filter(State != "Puerto Rico"), aes(x = reorder(State,Rank), y = Percent,group=RiskFactor,col=RiskFactor)) + 
  geom_line(alpha = .5) + ggtitle("Diagnosed Diabetes and Risk Factors")
g1+theme(axis.text.x = element_text(angle = 90))+xlab("Risk Factor")
```




```{r}
# Age <- na.omit(Age[-1,])
# full_join(Age, Num)%>%select(1:5,7)
# df_age <- gather(Age, key = "Age", value = "Percent", colnames(Age%>%select(2:5)))
# df_age
# ggparcoord(df_age, columns = 3, groupColumn = 2)
```


##V. Results
```{r}

```

##VI. Interactive component
```{r}

```


##VII. Conclusion
```{r}

```

